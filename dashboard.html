<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-app.js";
    import { getFirestore, collection, onSnapshot, query, orderBy } 
    from "https://www.gstatic.com/firebasejs/10.13.1/firebase-firestore.js";

    const firebaseConfig = {
        apiKey: "AIzaSyDJYuLpI7flTzq44Rjuvp_-Uk-001fe4jM",
        authDomain: "moodify-crowdplay.firebaseapp.com",
        projectId: "moodify-crowdplay",
        storageBucket: "moodify-crowdplay.firebasestorage.app",
        messagingSenderId: "1017921695722",
        appId: "1:1017921695722:web:d57678bef5930da17ccc93"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    const songList = document.getElementById("songList");

    /* ============================================
       ðŸ”µ PIE CHART SETUP
    ============================================== */

    let moodChart;
    const ctx = document.getElementById("moodPieChart").getContext("2d");

    function updateMoodChart(moodCount) {
        const labels = Object.keys(moodCount);
        const values = Object.values(moodCount);

        if (moodChart) moodChart.destroy();

        moodChart = new Chart(ctx, {
            type: "pie",
            data: {
                labels: labels,
                datasets: [{
                    data: values,
                    backgroundColor: [
                        "#ffb6d9", // sad
                        "#ffcf7d", // happy
                        "#b7f7df", // calm
                        "#a8c6ff", // blue
                        "#ff8b8b"  // angry
                    ],
                    borderWidth: 0
                }]
            },
            options: {
                plugins: {
                    legend: {
                        labels: { color: "#333" }
                    }
                }
            }
        });
    }

    /* ============================================
       ðŸ”´ REAL TIME PLAYLIST + PIE CHART
    ============================================== */

    const q = query(collection(db, "playlist"), orderBy("time", "desc"));

    onSnapshot(q, (snapshot) => {
        songList.innerHTML = ""; 

        let moodCount = {
            sad: 0,
            happy: 0,
            calm: 0,
            blue: 0,
            angry: 0
        };

        snapshot.forEach((doc) => {
            const song = doc.data();
            const mood = song.mood?.toLowerCase();

            if (moodCount[mood] !== undefined) {
                moodCount[mood]++;
            }

            const card = `
                <div class="song-card">
                    <div class="info">
                        <strong>${song.title}</strong><br>
                        <span>${song.artist}</span>
                    </div>
                    <div class="mood-tag ${mood}">
                        ${mood}
                    </div>
                </div>
            `;

            songList.innerHTML += card;
        });

        updateMoodChart(moodCount);
    });

</script>
